# Финальная документация по проекту "Умные Ворота"

Данный документ содержит полную информацию по проектированию устройства на базе **ESP32 DevKit 38 pin** для управления воротами через **433MHz брелки (включая CAME)**, **Wi-Fi (Алиса)** и **GSM**.

---



## 1. Схема подключения компонентов



## 1. Схема подключения компонентов

Данный документ описывает схему подключения всех выбранных компонентов к плате ESP32 на макетной плате, с учетом вашего **ESP32 DevKit 38 pin**, установленного с **b25-b43** и **h25-h43**, и предоставленной вами распиновки.

### Обзор компонентов

*   **ESP32 DevKit 38 pin**: Основной контроллер с Wi-Fi.
*   **Дисплей GMT130-V1.0 (ST7789)**: Цветной TFT дисплей с разрешением 240x240, интерфейс SPI.
*   **Джойстик KS0008**: Модуль джойстика с двумя аналоговыми осями (X, Y) и кнопкой.
*   **Радиомодуль SRX882 v1.3**: Приемник 433MHz.
*   **Светодиод**: Для индикации импульса.
*   **GSM модуль SIM800L**: Для приема звонков и SMS.

### Общие принципы подключения

*   **Питание**: ESP32 работает от 3.3В. Большинство модулей (дисплей, джойстик, SRX882) также могут работать от 3.3В или 5В. Для простоты и безопасности, будем использовать 3.3В от ESP32, если это возможно. GSM модуль SIM800L требует отдельного источника питания 5В.
*   **SPI для дисплея**: Дисплей ST7789 использует интерфейс SPI, который требует 4-5 пинов. Используем аппаратный SPI ESP32.
*   **Аналоговые входы для джойстика**: Оси X и Y джойстика подключаются к аналоговым пинам ESP32.
*   **Цифровые входы/выходы**: Кнопка джойстика, выход данных 433MHz приемника и светодиод подключаются к цифровым пинам.
*   **UART для GSM**: GSM модуль подключается через аппаратный UART2 ESP32.

### Детальная схема подключения

Ниже представлена таблица с пинами ESP32, их функциями и подключенными компонентами. Эта таблица является сводной и соответствует подробному описанию в файле `layout_description.md`.

| Пин ESP32 (положение) | GPIO | Функция / Компонент   | Примечание                                                                  |
| :-------------------- | :--- | :-------------------- | :-------------------------------------------------------------------------- |
| `b43`                 | 3V3  | Питание 3.3V          | Общая шина питания для дисплея, джойстика, SRX882                           |
| `b30`                 | GND  | Земля                 | Общая шина земли для всех компонентов                                       |
| `h37`                 | GND  | Земля                 | Дополнительная общая шина земли                                             |
| `h29`                 | G2   | Дисплей DC            | Выбор режима: данные/команда                                                |
| `h31`                 | G4   | Дисплей RST           | Сброс дисплея                                                               |
| `h34`                 | G5   | Дисплей CS            | Выбор чипа (дисплея)                                                        |
| `h35`                 | G18  | Дисплей SCK (SPI)     | Тактовый сигнал SPI                                                         |
| `h42`                 | G23  | Дисплей MOSI (SPI)    | Данные SPI                                                                  |
| `b39`                 | G34  | Джойстик VRx (ADC1_CH6) | Аналоговый вход для оси X                                                   |
| `b38`                 | G35  | Джойстик VRy (ADC1_CH7) | Аналоговый вход для оси Y                                                   |
| `b32`                 | G14  | Джойстик SW (Кнопка)  | Цифровой вход для кнопки (используйте `INPUT_PULLUP` в коде)                |
| `b29`                 | G13  | SRX882 DATA           | Цифровой вход для данных 433MHz                                             |
| `b31`                 | G12  | Светодиод             | Цифровой выход для управления светодиодом (через резистор 220 Ом)           |


### Дополнительные примечания:

*   **Дисплей BL (Подсветка)**: Подключите к 3.3V через резистор 100-220 Ом. Если хотите управлять яркостью, можно подключить к свободному GPIO, поддерживающему ШИМ (PWM), например, G15 (`h28`) или G25 (`b35`).
*   **SRX882 Антенна**: Припаяйте или подключите кусок провода длиной примерно 17 см к антенному пину SRX882.
*   **GSM SIM800L Питание**: **ОЧЕНЬ ВАЖНО!** GSM SIM800L требует отдельного источника питания 5V, способного выдавать до 2А. Не пытайтесь питать его от ESP32 или USB порта компьютера напрямую. Подключите VCC SIM800L к внешнему источнику 5V, а GND SIM800L к общей земле системы.
*   **GSM SIM800L (упрощенное подключение)**: Для работы GSM модуля SIM800L (только входящие звонки и SMS) необходимо подключить всего 4 пина: **VCC**, **GND**, **RXD** (ESP32) и **TXD** (ESP32). Остальные пины модуля (MIC+, MIC-, SPK+, SPK-, NET, RING, DTR, RST) остаются неподключенными.

Эта схема является основой для физического подключения. На следующем этапе мы перейдем к структуре кода, где эти пины будут использоваться.

---



## 2. Подробное описание расположения компонентов и подключений на макетной плате

Данный раздел предоставляет пошаговое руководство по размещению компонентов и подключению проводов на двух соединенных макетных платах, с учетом того, что ваша плата **ESP32 DevKit 38 pin** установлена с **b25-b43** и **h25-h43**, и с использованием предоставленных вами пинов.

### Общая структура макетных плат

Предполагается, что у вас две стандартные макетные платы, соединенные друг с другом. Верхняя плата имеет ряды `a-j` и номера `1-60`. Нижняя плата также имеет ряды `a-j` и номера `1-60`. ESP32 установлен так, что его левый ряд пинов находится в `b25-b43`, а правый ряд — в `h25-h43`.

### Распиновка ESP32 (по вашим данным):

**Левый ряд (вставлен в b25-b43):**
*   `b25`: V5
*   `b26`: CMD
*   `b27`: SD3
*   `b28`: SD2
*   `b29`: G13 (GPIO13)
*   `b30`: GND
*   `b31`: G12 (GPIO12)
*   `b32`: G14 (GPIO14)
*   `b33`: G27 (GPIO27)
*   `b34`: G26 (GPIO26)
*   `b35`: G25 (GPIO25)
*   `b36`: G33 (GPIO33)
*   `b37`: G32 (GPIO32)
*   `b38`: G35 (GPIO35)
*   `b39`: G34 (GPIO34)
*   `b40`: SN
*   `b41`: SP
*   `b42`: EN
*   `b43`: 3V3

**Правый ряд (вставлен в h25-h43):**
*   `h25`: CLK
*   `h26`: SD0
*   `h27`: SD1
*   `h28`: G15 (GPIO15)
*   `h29`: G2 (GPIO2)
*   `h30`: G0 (GPIO0)
*   `h31`: G4 (GPIO4)
*   `h32`: G16 (GPIO16)
*   `h33`: G17 (GPIO17)
*   `h34`: G5 (GPIO5)
*   `h35`: G18 (GPIO18)
*   `h36`: G19 (GPIO19)
*   `h37`: GND
*   `h38`: G21 (GPIO21)
*   `h39`: RXD (GPIO3)
*   `h40`: TXD (GPIO1)
*   `h41`: G22 (GPIO22)
*   `h42`: G23 (GPIO23)
*   `h43`: GND

### 1. Подключение питания и земли

Это первый и самый важный шаг. Убедитесь, что все соединения надежны.

1.  **Питание 3.3V от ESP32 к верхней шине питания:**
    *   Пин **3V3** (на ESP32, левый ряд, позиция `b43`) → **Красная шина питания верхней макетной платы** (например, в любое отверстие вдоль красной линии, скажем, `+1`). Используйте **красный провод**.
2.  **Земля от ESP32 к верхней шине земли:**
    *   Пин **GND** (на ESP32, левый ряд, позиция `b30`) → **Синяя шина земли верхней макетной платы** (например, в любое отверстие вдоль синей линии, скажем, `-1`). Используйте **черный провод**.
3.  **Земля от ESP32 к нижней шине земли:**
    *   Пин **GND** (на ESP32, правый ряд, позиция `h37`) → **Синяя шина земли нижней макетной платы** (например, в любое отверстие вдоль синей линии, скажем, `-1` нижней платы). Используйте **черный провод**.
4.  **Соединение шин питания и земли между платами (если они не соединены):**
    *   **Красная шина питания верхней платы** (`+1`) → **Красная шина питания нижней платы** (`+1` нижней платы). Используйте **красный провод**.
    *   **Синяя шина земли верхней платы** (`-1`) → **Синяя шина земли нижней платы** (`-1` нижней платы). Используйте **черный провод**.

### 2. Подключение дисплея GMT130-V1.0 (ST7789)

Учитывая, что у вашего дисплея 7 пинов в один ряд (GND, VCC, SCK, SDA, RES, DC, BLK), разместите его в верхней части верхней макетной платы так, чтобы пины были доступны для подключения.

1.  **Размещение дисплея**: Установите дисплей так, чтобы его пины были вставлены в ряд `a` верхней макетной платы, начиная с позиции `1` (т.е. `a1` для GND, `a2` для VCC и так далее до `a7` для BLK). Это позволит использовать соседние ряды `b`, `c` и т.д. для подключения проводов.
2.  **Питание дисплея**:
    *   Пин **VCC** дисплея (в `a2`) → **Красная шина питания верхней макетной платы** (`+1`). Используйте **красный провод**.
    *   Пин **GND** дисплея (в `a1`) → **Синяя шина земли верхней макетной платы** (`-1`). Используйте **черный провод**.
3.  **Подключение SPI (аппаратный SPI ESP32)**:
    *   Пин **SCK** дисплея (в `a3`) → Пин **G18** (на ESP32, правый ряд, позиция `h35`). Используйте **желтый провод**.
    *   Пин **SDA** дисплея (в `a4`) → Пин **G23** (на ESP32, правый ряд, позиция `h42`). *Примечание: SDA на дисплеях ST7789 обычно соответствует MOSI в SPI.* Используйте **оранжевый провод**.
4.  **Дополнительные пины дисплея**:
    *   Пин **RES** дисплея (в `a5`) → Пин **G4** (на ESP32, правый ряд, позиция `h31`). Используйте **серый провод**.
    *   Пин **DC** дисплея (в `a6`) → Пин **G2** (на ESP32, правый ряд, позиция `h29`). Используйте **белый провод**.
    *   Пин **BLK (Backlight)** дисплея (в `a7`) → **Красная шина питания верхней макетной платы** (`+1`) через резистор 100-220 Ом. Используйте **фиолетовый провод** и **резистор**.
    *   *Примечание: Пин CS (Chip Select) не указан в вашей распиновке дисплея. Если дисплей не имеет отдельного пина CS, возможно, он внутренне подключен к земле или используется другой метод выбора. Если возникнут проблемы, возможно, потребуется добавить пин CS, подключив его к G5 (`h34`).*

### 3. Подключение джойстика KS0008

Учитывая, что у вашего джойстика 5 пинов в один ряд (G, V, B, Y, X), разместите его в удобной области верхней макетной платы так, чтобы пины были доступны для подключения.

1.  **Размещение джойстика**: Установите джойстик так, чтобы его пины были вставлены в ряд `e` верхней макетной платы, начиная с позиции `10` (т.е. `e10` для G, `e11` для V и так далее до `e14` для X). Это позволит использовать соседние ряды `d`, `f` и т.д. для подключения проводов.
2.  **Питание джойстика**:
    *   Пин **V (VCC)** джойстика (в `e11`) → **Красная шина питания верхней макетной платы** (`+1`). Используйте **красный провод**.
    *   Пин **G (GND)** джойстика (в `e10`) → **Синяя шина земли верхней макетной платы** (`-1`). Используйте **черный провод**.
3.  **Подключение осей и кнопки**:
    *   Пин **X (VRx)** джойстика (в `e14`) → Пин **G34** (на ESP32, левый ряд, позиция `b39`). Используйте **синий провод**.
    *   Пин **Y (VRy)** джойстика (в `e13`) → Пин **G35** (на ESP32, левый ряд, позиция `b38`). Используйте **коричневый провод**.
    *   Пин **B (SW, кнопка)** джойстика (в `e12`) → Пин **G14** (на ESP32, левый ряд, позиция `b32`). Используйте **пурпурный провод**.

### 4. Подключение радиомодуля SRX882 v1.3 (433MHz приемник)

Разместите SRX882 в свободной области верхней макетной платы, например, рядом с джойстиком.

1.  **Размещение SRX882**: Установите модуль так, чтобы его пины были вставлены, например, в ряды `e` и `f` верхней макетной платы, начиная с позиции `10`.
2.  **Питание SRX882**:
    *   Пин **VCC** SRX882 → **Красная шина питания верхней макетной платы** (`+1`). Используйте **красный провод**.
    *   Пин **GND** SRX882 → **Синяя шина земли верхней макетной платы** (`-1`). Используйте **черный провод**.
3.  **Подключение данных**: 
    *   Пин **DATA** SRX882 → Пин **G13** (на ESP32, левый ряд, позиция `b29`). Используйте **зеленый провод**.
4.  **Антенна**: Припаяйте или подключите кусок провода длиной примерно 17 см к антенному пину SRX882.

### 5. Подключение светодиода

1.  **Размещение светодиода**: Установите светодиод в любой свободной области верхней макетной платы.
2.  **Подключение светодиода**:
    *   Длинная ножка (анод) светодиода → Резистор 220 Ом → Пин **G12** (на ESP32, левый ряд, позиция `b31`). Используйте **желтый провод**.
    *   Короткая ножка (катод) светодиода → **Синяя шина земли верхней макетной платы** (`-1`). Используйте **черный провод**.

### 6. Подключение GSM модуля SIM800L

Разместите SIM800L на нижней макетной плате. Для упрощенной функциональности (только входящие звонки и SMS) нам потребуются только пины питания и UART.

1.  **Размещение GSM модуля**: Установите SIM800L на нижней макетной плате. Подключите только необходимые пины: VCC, GND, RXD, TXD.
2.  **Питание GSM модуля**: **ОЧЕНЬ ВАЖНО!** GSM SIM800L требует отдельного источника питания 5V, способного выдавать до 2А. Не пытайтесь питать его от ESP32 или USB порта компьютера напрямую. Подключите VCC SIM800L к внешнему источнику 5V, а GND SIM800L к общей земле системы.
3.  **Подключение UART2 (аппаратный UART ESP32)**:
    *   Пин **RXD** SIM800L → Пин **G16** (на ESP32, правый ряд, позиция `h32`). Используйте **оранжевый провод**.
    *   Пин **TXD** SIM800L → Пин **G17** (на ESP32, правый ряд, позиция `h33`). Используйте **синий провод**.

---



## 2. Подробное описание расположения компонентов и подключений на макетной плате

Данный раздел предоставляет пошаговое руководство по размещению компонентов и подключению проводов на двух соединенных макетных платах, с учетом того, что ваша плата **ESP32 DevKit 38 pin** установлена с **b25-b43** и **h25-h43**, и с использованием предоставленных вами пинов.

### Общая структура макетных плат

Предполагается, что у вас две стандартные макетные платы, соединенные друг с другом. Верхняя плата имеет ряды `a-j` и номера `1-60`. Нижняя плата также имеет ряды `a-j` и номера `1-60`. ESP32 установлен так, что его левый ряд пинов находится в `b25-b43`, а правый ряд — в `h25-h43`.

### Распиновка ESP32 (по вашим данным):

**Левый ряд (вставлен в b25-b43):**
*   `b25`: V5
*   `b26`: CMD
*   `b27`: SD3
*   `b28`: SD2
*   `b29`: G13 (GPIO13)
*   `b30`: GND
*   `b31`: G12 (GPIO12)
*   `b32`: G14 (GPIO14)
*   `b33`: G27 (GPIO27)
*   `b34`: G26 (GPIO26)
*   `b35`: G25 (GPIO25)
*   `b36`: G33 (GPIO33)
*   `b37`: G32 (GPIO32)
*   `b38`: G35 (GPIO35)
*   `b39`: G34 (GPIO34)
*   `b40`: SN
*   `b41`: SP
*   `b42`: EN
*   `b43`: 3V3

**Правый ряд (вставлен в h25-h43):**
*   `h25`: CLK
*   `h26`: SD0
*   `h27`: SD1
*   `h28`: G15 (GPIO15)
*   `h29`: G2 (GPIO2)
*   `h30`: G0 (GPIO0)
*   `h31`: G4 (GPIO4)
*   `h32`: G16 (GPIO16)
*   `h33`: G17 (GPIO17)
*   `h34`: G5 (GPIO5)
*   `h35`: G18 (GPIO18)
*   `h36`: G19 (GPIO19)
*   `h37`: GND
*   `h38`: G21 (GPIO21)
*   `h39`: RXD (GPIO3)
*   `h40`: TXD (GPIO1)
*   `h41`: G22 (GPIO22)
*   `h42`: G23 (GPIO23)
*   `h43`: GND

### 1. Подключение питания и земли

Это первый и самый важный шаг. Убедитесь, что все соединения надежны.

1.  **Питание 3.3V от ESP32 к верхней шине питания:**
    *   Пин **3V3** (на ESP32, левый ряд, позиция `b43`) → **Красная шина питания верхней макетной платы** (например, в любое отверстие вдоль красной линии, скажем, `+1`). Используйте **красный провод**.
2.  **Земля от ESP32 к верхней шине земли:**
    *   Пин **GND** (на ESP32, левый ряд, позиция `b30`) → **Синяя шина земли верхней макетной платы** (например, в любое отверстие вдоль синей линии, скажем, `-1`). Используйте **черный провод**.
3.  **Земля от ESP32 к нижней шине земли:**
    *   Пин **GND** (на ESP32, правый ряд, позиция `h37`) → **Синяя шина земли нижней макетной платы** (например, в любое отверстие вдоль синей линии, скажем, `-1` нижней платы). Используйте **черный провод**.
4.  **Соединение шин питания и земли между платами (если они не соединены):**
    *   **Красная шина питания верхней платы** (`+1`) → **Красная шина питания нижней платы** (`+1` нижней платы). Используйте **красный провод**.
    *   **Синяя шина земли верхней платы** (`-1`) → **Синяя шина земли нижней платы** (`-1` нижней платы). Используйте **черный провод**.

### 2. Подключение дисплея GMT130-V1.0 (ST7789)

Учитывая, что у вашего дисплея 7 пинов в один ряд (GND, VCC, SCK, SDA, RES, DC, BLK), разместите его в верхней части верхней макетной платы так, чтобы пины были доступны для подключения.

1.  **Размещение дисплея**: Установите дисплей так, чтобы его пины были вставлены в ряд `a` верхней макетной платы, начиная с позиции `1` (т.е. `a1` для GND, `a2` для VCC и так далее до `a7` для BLK). Это позволит использовать соседние ряды `b`, `c` и т.д. для подключения проводов.
2.  **Питание дисплея**:
    *   Пин **VCC** дисплея (в `a2`) → **Красная шина питания верхней макетной платы** (`+1`). Используйте **красный провод**.
    *   Пин **GND** дисплея (в `a1`) → **Синяя шина земли верхней макетной платы** (`-1`). Используйте **черный провод**.
3.  **Подключение SPI (аппаратный SPI ESP32)**:
    *   Пин **SCK** дисплея (в `a3`) → Пин **G18** (на ESP32, правый ряд, позиция `h35`). Используйте **желтый провод**.
    *   Пин **SDA** дисплея (в `a4`) → Пин **G23** (на ESP32, правый ряд, позиция `h42`). *Примечание: SDA на дисплеях ST7789 обычно соответствует MOSI в SPI.* Используйте **оранжевый провод**.
4.  **Дополнительные пины дисплея**:
    *   Пин **RES** дисплея (в `a5`) → Пин **G4** (на ESP32, правый ряд, позиция `h31`). Используйте **серый провод**.
    *   Пин **DC** дисплея (в `a6`) → Пин **G2** (на ESP32, правый ряд, позиция `h29`). Используйте **белый провод**.
    *   Пин **BLK (Backlight)** дисплея (в `a7`) → **Красная шина питания верхней макетной платы** (`+1`) через резистор 100-220 Ом. Используйте **фиолетовый провод** и **резистор**.
    *   *Примечание: Пин CS (Chip Select) не указан в вашей распиновке дисплея. Если дисплей не имеет отдельного пина CS, возможно, он внутренне подключен к земле или используется другой метод выбора. Если возникнут проблемы, возможно, потребуется добавить пин CS, подключив его к G5 (`h34`).*

### 3. Подключение джойстика KS0008

Учитывая, что у вашего джойстика 5 пинов в один ряд (G, V, B, Y, X), разместите его в удобной области верхней макетной платы так, чтобы пины были доступны для подключения.

1.  **Размещение джойстика**: Установите джойстик так, чтобы его пины были вставлены в ряд `e` верхней макетной платы, начиная с позиции `10` (т.е. `e10` для G, `e11` для V и так далее до `e14` для X). Это позволит использовать соседние ряды `d`, `f` и т.д. для подключения проводов.
2.  **Питание джойстика**:
    *   Пин **V (VCC)** джойстика (в `e11`) → **Красная шина питания верхней макетной платы** (`+1`). Используйте **красный провод**.
    *   Пин **G (GND)** джойстика (в `e10`) → **Синяя шина земли верхней макетной платы** (`-1`). Используйте **черный провод**.
3.  **Подключение осей и кнопки**:
    *   Пин **X (VRx)** джойстика (в `e14`) → Пин **G34** (на ESP32, левый ряд, позиция `b39`). Используйте **синий провод**.
    *   Пин **Y (VRy)** джойстика (в `e13`) → Пин **G35** (на ESP32, левый ряд, позиция `b38`). Используйте **коричневый провод**.
    *   Пин **B (SW, кнопка)** джойстика (в `e12`) → Пин **G14** (на ESP32, левый ряд, позиция `b32`). Используйте **пурпурный провод**.

### 4. Подключение радиомодуля SRX882 v1.3 (433MHz приемник)

Разместите SRX882 в свободной области верхней макетной платы, например, рядом с джойстиком.

1.  **Размещение SRX882**: Установите модуль так, чтобы его пины были вставлены, например, в ряды `e` и `f` верхней макетной платы, начиная с позиции `10`.
2.  **Питание SRX882**:
    *   Пин **VCC** SRX882 → **Красная шина питания верхней макетной платы** (`+1`). Используйте **красный провод**.
    *   Пин **GND** SRX882 → **Синяя шина земли верхней макетной платы** (`-1`). Используйте **черный провод**.
3.  **Подключение данных**: 
    *   Пин **DATA** SRX882 → Пин **G13** (на ESP32, левый ряд, позиция `b29`). Используйте **зеленый провод**.
4.  **Антенна**: Припаяйте или подключите кусок провода длиной примерно 17 см к антенному пину SRX882.

### 5. Подключение светодиода

1.  **Размещение светодиода**: Установите светодиод в любой свободной области верхней макетной платы.
2.  **Подключение светодиода**:
    *   Длинная ножка (анод) светодиода → Резистор 220 Ом → Пин **G12** (на ESP32, левый ряд, позиция `b31`). Используйте **желтый провод**.
    *   Короткая ножка (катод) светодиода → **Синяя шина земли верхней макетной платы** (`-1`). Используйте **черный провод**.

### 6. Подключение GSM модуля SIM800L

Разместите SIM800L на нижней макетной плате. Для упрощенной функциональности (только входящие звонки и SMS) нам потребуются только пины питания и UART.

1.  **Размещение GSM модуля**: Установите SIM800L на нижней макетной плате. Подключите только необходимые пины: VCC, GND, RXD, TXD.
2.  **Питание GSM модуля**: **ОЧЕНЬ ВАЖНО!** GSM SIM800L требует отдельного источника питания 5V, способного выдавать до 2А. Не пытайтесь питать его от ESP32 или USB порта компьютера напрямую. Подключите VCC SIM800L к внешнему источнику 5V, а GND SIM800L к общей земле системы.
3.  **Подключение UART2 (последовательная связь)**:
    *   Пин **RXD** SIM800L → Пин **G16** (на ESP32, правый ряд, позиция `h32`). Используйте **оранжевый провод**.
    *   Пин **TXD** SIM800L → Пин **G17** (на ESP32, правый ряд, позиция `h33`). Используйте **синий провод**.


### Сводная таблица пинов ESP32 (по вашим данным)

| Пин ESP32 (положение) | GPIO | Функция / Компонент   | Примечание                                                                  |
| :-------------------- | :--- | :-------------------- | :-------------------------------------------------------------------------- |
| `b43`                 | 3V3  | Питание 3.3V          | Общая шина питания для дисплея, джойстика, SRX882                           |
| `b30`                 | GND  | Земля                 | Общая шина земли для всех компонентов                                       |
| `h37`                 | GND  | Земля                 | Дополнительная общая шина земли                                             |
| `h35`                 | G18  | Дисплей SCK (SPI)     | Тактовый сигнал SPI                                                         |
| `h42`                 | G23  | Дисплей SDA (MOSI)    | Данные SPI                                                                  |
| `h31`                 | G4   | Дисплей RES           | Сброс дисплея                                                               |
| `h29`                 | G2   | Дисплей DC            | Выбор режима: данные/команда                                                |
| `h34`                 | G5   | Дисплей CS            | *Опционально, если дисплей имеет пин CS. Если нет, этот пин ESP32 свободен.*|
| `b39`                 | G34  | Джойстик VRx (ADC1_CH6) | Аналоговый вход для оси X                                                   |
| `b38`                 | G35  | Джойстик VRy (ADC1_CH7) | Аналоговый вход для оси Y                                                   |
| `b32`                 | G14  | Джойстик SW (Кнопка)  | Цифровой вход для кнопки (используйте `INPUT_PULLUP` в коде)                |
| `b29`                 | G13  | SRX882 DATA           | Цифровой вход для данных 433MHz                                             |
| `b31`                 | G12  | Светодиод             | Цифровой выход для управления светодиодом (через резистор 220 Ом)           |
| `h32`                 | G16  | GSM TX (UART2 TX)     | Передача данных от ESP32 к GSM модулю (подключается к пину RX SIM800L)     |
| `h33`                 | G17  | GSM RX (UART2 RX)     | Прием данных от GSM модуля к ESP32 (подключается к пину TX SIM800L)       |

### Рекомендации по сборке

*   **Короткие провода**: Используйте провода минимально необходимой длины, чтобы избежать путаницы и помех.
*   **Цветовая кодировка**: Придерживайтесь стандартной цветовой кодировки (красный для VCC, черный для GND) для облегчения отладки.
*   **Двойная проверка**: Перед подачей питания на устройство, тщательно проверьте все соединения на предмет коротких замыканий и правильности подключения.
*   **GSM питание**: Еще раз убедитесь, что GSM SIM800L подключен к отдельному источнику питания 5V с достаточным током. Несоблюдение этого может привести к нестабильной работе или повреждению ESP32.

Теперь у вас есть максимально точное описание для физической сборки вашего проекта. Удачи!

---



## 2. Подробное описание расположения компонентов и подключений на макетной плате

Данный раздел предоставляет пошаговое руководство по размещению компонентов и подключению проводов на двух соединенных макетных платах, с учетом того, что ваша плата **ESP32 DevKit 38 pin** установлена с **b25-b43** и **h25-h43**, и с использованием предоставленных вами пинов.

### Общая структура макетных плат

Предполагается, что у вас две стандартные макетные платы, соединенные друг с другом. Верхняя плата имеет ряды `a-j` и номера `1-60`. Нижняя плата также имеет ряды `a-j` и номера `1-60`. ESP32 установлен так, что его левый ряд пинов находится в `b25-b43`, а правый ряд — в `h25-h43`.

### Распиновка ESP32 (по вашим данным):

**Левый ряд (вставлен в b25-b43):**
*   `b25`: V5
*   `b26`: CMD
*   `b27`: SD3
*   `b28`: SD2
*   `b29`: G13 (GPIO13)
*   `b30`: GND
*   `b31`: G12 (GPIO12)
*   `b32`: G14 (GPIO14)
*   `b33`: G27 (GPIO27)
*   `b34`: G26 (GPIO26)
*   `b35`: G25 (GPIO25)
*   `b36`: G33 (GPIO33)
*   `b37`: G32 (GPIO32)
*   `b38`: G35 (GPIO35)
*   `b39`: G34 (GPIO34)
*   `b40`: SN
*   `b41`: SP
*   `b42`: EN
*   `b43`: 3V3

**Правый ряд (вставлен в h25-h43):**
*   `h25`: CLK
*   `h26`: SD0
*   `h27`: SD1
*   `h28`: G15 (GPIO15)
*   `h29`: G2 (GPIO2)
*   `h30`: G0 (GPIO0)
*   `h31`: G4 (GPIO4)
*   `h32`: G16 (GPIO16)
*   `h33`: G17 (GPIO17)
*   `h34`: G5 (GPIO5)
*   `h35`: G18 (GPIO18)
*   `h36`: G19 (GPIO19)
*   `h37`: GND
*   `h38`: G21 (GPIO21)
*   `h39`: RXD (GPIO3)
*   `h40`: TXD (GPIO1)
*   `h41`: G22 (GPIO22)
*   `h42`: G23 (GPIO23)
*   `h43`: GND

### 1. Подключение питания и земли

Это первый и самый важный шаг. Убедитесь, что все соединения надежны.

1.  **Питание 3.3V от ESP32 к верхней шине питания:**
    *   Пин **3V3** (на ESP32, левый ряд, позиция `b43`) → **Красная шина питания верхней макетной платы** (например, в любое отверстие вдоль красной линии, скажем, `+1`). Используйте **красный провод**.
2.  **Земля от ESP32 к верхней шине земли:**
    *   Пин **GND** (на ESP32, левый ряд, позиция `b30`) → **Синяя шина земли верхней макетной платы** (например, в любое отверстие вдоль синей линии, скажем, `-1`). Используйте **черный провод**.
3.  **Земля от ESP32 к нижней шине земли:**
    *   Пин **GND** (на ESP32, правый ряд, позиция `h37`) → **Синяя шина земли нижней макетной платы** (например, в любое отверстие вдоль синей линии, скажем, `-1` нижней платы). Используйте **черный провод**.
4.  **Соединение шин питания и земли между платами (если они не соединены):**
    *   **Красная шина питания верхней платы** (`+1`) → **Красная шина питания нижней платы** (`+1` нижней платы). Используйте **красный провод**.
    *   **Синяя шина земли верхней платы** (`-1`) → **Синяя шина земли нижней платы** (`-1` нижней платы). Используйте **черный провод**.

### 2. Подключение дисплея GMT130-V1.0 (ST7789)

Учитывая, что у вашего дисплея 7 пинов в один ряд (GND, VCC, SCK, SDA, RES, DC, BLK), разместите его в верхней части верхней макетной платы так, чтобы пины были доступны для подключения.

1.  **Размещение дисплея**: Установите дисплей так, чтобы его пины были вставлены в ряд `a` верхней макетной платы, начиная с позиции `1` (т.е. `a1` для GND, `a2` для VCC и так далее до `a7` для BLK). Это позволит использовать соседние ряды `b`, `c` и т.д. для подключения проводов.
2.  **Питание дисплея**:
    *   Пин **VCC** дисплея (в `a2`) → **Красная шина питания верхней макетной платы** (`+1`). Используйте **красный провод**.
    *   Пин **GND** дисплея (в `a1`) → **Синяя шина земли верхней макетной платы** (`-1`). Используйте **черный провод**.
3.  **Подключение SPI (аппаратный SPI ESP32)**:
    *   Пин **SCK** дисплея (в `a3`) → Пин **G18** (на ESP32, правый ряд, позиция `h35`). Используйте **желтый провод**.
    *   Пин **SDA** дисплея (в `a4`) → Пин **G23** (на ESP32, правый ряд, позиция `h42`). *Примечание: SDA на дисплеях ST7789 обычно соответствует MOSI в SPI.* Используйте **оранжевый провод**.
4.  **Дополнительные пины дисплея**:
    *   Пин **RES** дисплея (в `a5`) → Пин **G4** (на ESP32, правый ряд, позиция `h31`). Используйте **серый провод**.
    *   Пин **DC** дисплея (в `a6`) → Пин **G2** (на ESP32, правый ряд, позиция `h29`). Используйте **белый провод**.
    *   Пин **BLK (Backlight)** дисплея (в `a7`) → **Красная шина питания верхней макетной платы** (`+1`) через резистор 100-220 Ом. Используйте **фиолетовый провод** и **резистор**.
    *   *Примечание: Пин CS (Chip Select) не указан в вашей распиновке дисплея. Если дисплей не имеет отдельного пина CS, возможно, он внутренне подключен к земле или используется другой метод выбора. Если возникнут проблемы, возможно, потребуется добавить пин CS, подключив его к G5 (`h34`).*

### 3. Подключение джойстика KS0008

Учитывая, что у вашего джойстика 5 пинов в один ряд (G, V, B, Y, X), разместите его в удобной области верхней макетной платы так, чтобы пины были доступны для подключения.

1.  **Размещение джойстика**: Установите джойстик так, чтобы его пины были вставлены в ряд `e` верхней макетной платы, начиная с позиции `10` (т.е. `e10` для G, `e11` для V и так далее до `e14` для X). Это позволит использовать соседние ряды `d`, `f` и т.д. для подключения проводов.
2.  **Питание джойстика**:
    *   Пин **V (VCC)** джойстика (в `e11`) → **Красная шина питания верхней макетной платы** (`+1`). Используйте **красный провод**.
    *   Пин **G (GND)** джойстика (в `e10`) → **Синяя шина земли верхней макетной платы** (`-1`). Используйте **черный провод**.
3.  **Подключение осей и кнопки**:
    *   Пин **X (VRx)** джойстика (в `e14`) → Пин **G34** (на ESP32, левый ряд, позиция `b39`). Используйте **синий провод**.
    *   Пин **Y (VRy)** джойстика (в `e13`) → Пин **G35** (на ESP32, левый ряд, позиция `b38`). Используйте **коричневый провод**.
    *   Пин **B (SW, кнопка)** джойстика (в `e12`) → Пин **G14** (на ESP32, левый ряд, позиция `b32`). Используйте **пурпурный провод**.

### 4. Подключение радиомодуля SRX882 v1.3 (433MHz приемник)

Разместите SRX882 в свободной области верхней макетной платы, например, рядом с джойстиком.

1.  **Размещение SRX882**: Установите модуль так, чтобы его пины были вставлены, например, в ряды `e` и `f` верхней макетной платы, начиная с позиции `10`.
2.  **Питание SRX882**:
    *   Пин **VCC** SRX882 → **Красная шина питания верхней макетной платы** (`+1`). Используйте **красный провод**.
    *   Пин **GND** SRX882 → **Синяя шина земли верхней макетной платы** (`-1`). Используйте **черный провод**.
3.  **Подключение данных**: 
    *   Пин **DATA** SRX882 → Пин **G13** (на ESP32, левый ряд, позиция `b29`). Используйте **зеленый провод**.
4.  **Антенна**: Припаяйте или подключите кусок провода длиной примерно 17 см к антенному пину SRX882.

### 5. Подключение светодиода

1.  **Размещение светодиода**: Установите светодиод в любой свободной области верхней макетной платы.
2.  **Подключение светодиода**:
    *   Длинная ножка (анод) светодиода → Резистор 220 Ом → Пин **G12** (на ESP32, левый ряд, позиция `b31`). Используйте **желтый провод**.
    *   Короткая ножка (катод) светодиода → **Синяя шина земли верхней макетной платы** (`-1`). Используйте **черный провод**.

### 6. Подключение GSM модуля SIM800L

Разместите SIM800L на нижней макетной плате. Для упрощенной функциональности (только входящие звонки и SMS) нам потребуются только пины питания и UART.

1.  **Размещение GSM модуля**: Установите SIM800L на нижней макетной плате. Подключите только необходимые пины: VCC, GND, RXD, TXD.
2.  **Питание GSM модуля**: **ОЧЕНЬ ВАЖНО!** GSM SIM800L требует отдельного источника питания 5V, способного выдавать до 2А. Не пытайтесь питать его от ESP32 или USB порта компьютера напрямую. Подключите VCC SIM800L к внешнему источнику 5V, а GND SIM800L к общей земле системы.
3.  **Подключение UART2 (последовательная связь)**:
    *   Пин **RXD** SIM800L → Пин **G16** (на ESP32, правый ряд, позиция `h32`). Используйте **оранжевый провод**.
    *   Пин **TXD** SIM800L → Пин **G17** (на ESP32, правый ряд, позиция `h33`). Используйте **синий провод**.


### Сводная таблица пинов ESP32 (по вашим данным)

| Пин ESP32 (положение) | GPIO | Функция / Компонент   | Примечание                                                                  |
| :-------------------- | :--- | :-------------------- | :-------------------------------------------------------------------------- |
| `b43`                 | 3V3  | Питание 3.3V          | Общая шина питания для дисплея, джойстика, SRX882                           |
| `b30`                 | GND  | Земля                 | Общая шина земли для всех компонентов                                       |
| `h37`                 | GND  | Земля                 | Дополнительная общая шина земли                                             |
| `h35`                 | G18  | Дисплей SCK (SPI)     | Тактовый сигнал SPI                                                         |
| `h42`                 | G23  | Дисплей SDA (MOSI)    | Данные SPI                                                                  |
| `h31`                 | G4   | Дисплей RES           | Сброс дисплея                                                               |
| `h29`                 | G2   | Дисплей DC            | Выбор режима: данные/команда                                                |
| `h34`                 | G5   | Дисплей CS            | *Опционально, если дисплей имеет пин CS. Если нет, этот пин ESP32 свободен.*|
| `b39`                 | G34  | Джойстик VRx (ADC1_CH6) | Аналоговый вход для оси X                                                   |
| `b38`                 | G35  | Джойстик VRy (ADC1_CH7) | Аналоговый вход для оси Y                                                   |
| `b32`                 | G14  | Джойстик SW (Кнопка)  | Цифровой вход для кнопки (используйте `INPUT_PULLUP` в коде)                |
| `b29`                 | G13  | SRX882 DATA           | Цифровой вход для данных 433MHz                                             |
| `b31`                 | G12  | Светодиод             | Цифровой выход для управления светодиодом (через резистор 220 Ом)           |
| `h32`                 | G16  | GSM TX (UART2 TX)     | Передача данных от ESP32 к GSM модулю (подключается к пину RX SIM800L)     |
| `h33`                 | G17  | GSM RX (UART2 RX)     | Прием данных от GSM модуля к ESP32 (подключается к пину TX SIM800L)       |

### Рекомендации по сборке

*   **Короткие провода**: Используйте провода минимально необходимой длины, чтобы избежать путаницы и помех.
*   **Цветовая кодировка**: Придерживайтесь стандартной цветовой кодировки (красный для VCC, черный для GND) для облегчения отладки.
*   **Двойная проверка**: Перед подачей питания на устройство, тщательно проверьте все соединения на предмет коротких замыканий и правильности подключения.
*   **GSM питание**: Еще раз убедитесь, что GSM SIM800L подключен к отдельному источнику питания 5V с достаточным током. Несоблюдение этого может привести к нестабильной работе или повреждению ESP32.

Теперь у вас есть максимально точное описание для физической сборки вашего проекта. Удачи!

---



## 3. Структура кода для ESP32 DevKit 38 pin

Данный документ описывает высокоуровневую структуру кода для микроконтроллера ESP32 DevKit 38 pin, который будет управлять устройством. Код будет написан на языке C++ с использованием Arduino IDE или PlatformIO.

### Обзор функционала

1.  **Инициализация**: Настройка всех периферийных устройств (дисплей, джойстик, 433MHz приемник, Wi-Fi).
2.  **Пользовательский интерфейс (UI)**: Отображение меню на дисплее GMT130-V1.0 и навигация с помощью джойстика.
3.  **Управление Wi-Fi**: Подключение к выбранной сети, сохранение учетных данных, возможность выбора сети через UI или веб-интерфейс.
4.  **Обработка 433MHz сигналов**: Прием и декодирование сигналов с брелков (включая протокол CAME), хранение доверенных ключей.
5.  **Управление диодом/воротами**: Подача импульса на диод (или блок ворот).
6.  **Интеграция с Алисой**: Взаимодействие с навыком "Домовенок Кузя" через Wi-Fi.
7.  **GSM модуль (опционально)**: Обработка звонков/SMS с доверенных номеров.

### Основные библиотеки

Для реализации функционала потребуются следующие библиотеки:

*   **Для дисплея ST7789**: `Adafruit_GFX` и `Adafruit_ST7789` (или аналогичные, например, `TFT_eSPI`).
*   **Для Wi-Fi**: Встроенные библиотеки ESP32 DevKit 38 pin (`WiFi.h`, `WebServer.h`).
*   **Для 433MHz**: `RC_Switch` (или `NewRemoteSwitch`) для декодирования сигналов.
*   **Для GSM**: `TinyGSM` (если используется SIM800L или аналогичный).
*   **Для работы с EEPROM/Preferences**: `Preferences.h` для сохранения настроек Wi-Fi и ключей.

### Структура файлов и модулей

Предлагается следующая модульная структура для удобства разработки и поддержки:

```cpp
// main.ino или main.cpp
#include <Arduino.h>
#include <WiFi.h>
#include <WebServer.h>
#include <Preferences.h>
#include <Adafruit_GFX.h>
#include <Adafruit_ST7789.h>
#include <RC_Switch.h>
#include <TinyGSM.h> // Для GSM


// Подключение кастомных модулей
#include "DisplayManager.h"
#include "InputManager.h"
#include "RF433Receiver.h"
#include "WiFiManager.h"
#include "GateControl.h"
#include "GSMManager.h" // Для GSM

// Глобальные объекты
Preferences preferences; // Для сохранения данных в NVS
Adafruit_ST7789 tft = Adafruit_ST7789(TFT_CS, TFT_DC, TFT_RST); // Объект дисплея
RC_Switch mySwitch = RC_Switch(); // Объект 433MHz приемника
WebServer server(80); // Веб-сервер для конфигурации

// Для GSM
TinyGsm modem(Serial2); // Используем HardwareSerial2 для SIM800L (только для звонков и SMS)

// --- Setup Function ---
void setup() {
  Serial.begin(115200);
  Serial.println("Booting...");

  preferences.begin("smart-gate", false); // Инициализация NVS

  // Инициализация DisplayManager
  DisplayManager::init(&tft);
  DisplayManager::showSplashScreen();

  // Инициализация InputManager (джойстик)
  InputManager::init(JOY_VRX_PIN, JOY_VRY_PIN, JOY_SW_PIN);

  // Инициализация RF433Receiver
  mySwitch.enableReceive(RF_DATA_PIN); // Включаем прием на указанном пине
  RF433Receiver::init(&mySwitch); // Передаем объект mySwitch в менеджер

  // Инициализация GateControl (светодиод)
  GateControl::init(LED_PIN);

  // Инициализация WiFiManager
  WiFiManager::init(&preferences, &server);
  WiFiManager::connectToWiFi();

    // Инициализация GSMManager (опционально, только для входящих звонков и SMS)
    GSMManager::init(&modem, GSM_TX_PIN, GSM_RX_PIN); // Передаем объект модема и пины
    // Модем будет настроен в GSMManager::init для работы только с звонками и SMS.

  // Настройка веб-сервера (если используется)
  WiFiManager::setupWebServer();

  Serial.println("Setup complete.");
}

// --- Loop Function ---
void loop() {
  // Обновление UI и обработка джойстика
  InputManager::handleInput();
  DisplayManager::updateMenu(InputManager::getMenuState());

  // Обработка 433MHz сигналов
  if (mySwitch.available()) {
    RF433Receiver::handleReceivedCode(mySwitch.getReceivedValue(), mySwitch.getReceivedBitlength(), mySwitch.getReceivedProtocol());
    mySwitch.resetAvailable();
  }

  // Обработка веб-запросов
  server.handleClient();

  // Обработка GSM (опционально)
  GSMManager::handleGSM();

  // Проверка состояния Wi-Fi и переподключение при необходимости
  WiFiManager::checkConnection();

  // Другие фоновые задачи
  delay(10);
}

// --- Модуль DisplayManager.h/cpp ---
// Управление дисплеем: инициализация, отрисовка меню, текста, сплэш-скрина.
namespace DisplayManager {
  void init(Adafruit_ST7789* display);
  void showSplashScreen();
  void updateMenu(int menuState); // Отображение текущего пункта меню
  void showWifiConfigScreen();
  void showKeyManagementScreen();
  void printMessage(const String& message, int duration_ms = 0);
}

// --- Модуль InputManager.h/cpp ---
// Управление джойстиком: чтение аналоговых значений, обработка нажатий кнопки, навигация по меню.
namespace InputManager {
  void init(int vrxPin, int vryPin, int swPin);
  void handleInput();
  int getMenuState(); // Возвращает текущее состояние меню или выбранный пункт
  bool isButtonPressed();
}

// --- Модуль RF433Receiver.h/cpp ---
// Прием и декодирование 433MHz сигналов, хранение и проверка доверенных ключей.
// Использует Preferences для сохранения ключей.
namespace RF433Receiver {
  void init(RC_Switch* rcSwitch);
  void handleReceivedCode(unsigned long receivedCode, unsigned int bitLength, unsigned int protocol);
  bool isTrustedKey(unsigned long code);
  void addKey(unsigned long code);
  void removeKey(unsigned long code);
  void loadKeys();
  void saveKeys();
}

// --- Модуль WiFiManager.h/cpp ---
// Управление Wi-Fi подключением, сохранение учетных данных, веб-сервер для настройки.
// Интеграция с Алисой (через MQTT или HTTP запросы к облаку).
namespace WiFiManager {
  void init(Preferences* prefs, WebServer* webServer);
  void connectToWiFi();
  void checkConnection();
  void setupWebServer(); // Настройка обработчиков веб-запросов
  void handleRoot();
  void handleWifiSave();
  void handleNotFound();
  void sendActionToAlice(const String& action); // Функция для отправки команд Алисе
  bool isConnected();
}

// --- Модуль GateControl.h/cpp ---
// Управление подачей импульса на диод/ворота.
namespace GateControl {
  void init(int ledPin);
  void triggerGatePulse(int duration_ms = 500);
}

// --- Модуль GSMManager.h/cpp (опционально) ---
// Управление GSM модулем: прием входящих звонков и SMS, обработка доверенных номеров.
namespace GSMManager {
  void init(TinyGsm* modem, int txPin, int rxPin); // Передаем объект модема и пины
  void handleGSM();
  bool isTrustedNumber(const String& number);
  void addTrustedNumber(const String& number);
  void removeTrustedNumber(const String& number);
}

// --- Константы пинов ---
// Пины для дисплея GMT130-V1.0 (ST7789)
#define TFT_CS    GPIO5  // Chip Select pin (ESP32 G5)
#define TFT_DC    GPIO2  // Data/Command pin (ESP32 G2)
#define TFT_RST   GPIO4  // Reset pin (ESP32 G4)

// Пины для джойстика KS0008
#define JOY_VRX_PIN GPIO34 // (ESP32 G34)
#define JOY_VRY_PIN GPIO35 // (ESP32 G35)
#define JOY_SW_PIN  GPIO14 // (ESP32 G14)

// Пин для радиомодуля SRX882 v1.3
#define RF_DATA_PIN GPIO13 // (ESP32 G13)

// Пин для светодиода
#define LED_PIN     GPIO12 // (ESP32 G12)

// Пины для GSM SIM800L (UART2)
#define GSM_RX_PIN  GPIO17 // RX пин для UART2 (ESP32 G17) - подключается к TX GSM модуля
#define GSM_TX_PIN  GPIO16 // TX пин для UART2 (ESP32 G16) - подключается к RX GSM модуля
```

### Описание основных функций

### `setup()`

*   Инициализация `Serial` для отладки.
*   Инициализация `Preferences` для сохранения постоянных данных (Wi-Fi учетные данные, 433MHz ключи, доверенные GSM номера).
*   Вызов `init()` для каждого менеджера (Display, Input, RF433, WiFi, Gate, GSM).
*   Попытка подключения к Wi-Fi.
*   Настройка обработчиков веб-сервера.

### `loop()`

*   Постоянный опрос джойстика (`InputManager::handleInput()`) и обновление дисплея (`DisplayManager::updateMenu()`).
*   Проверка наличия принятых 433MHz сигналов (`mySwitch.available()`) и их обработка (`RF433Receiver::handleReceivedCode()`).
*   Обработка входящих веб-запросов (`server.handleClient()`).
*   Проверка состояния Wi-Fi соединения и попытка переподключения при разрыве (`WiFiManager::checkConnection()`).
*   Обработка GSM модуля (`GSMManager::handleGSM()`) для проверки звонков/SMS.

### Менеджеры

Каждый модуль (`DisplayManager`, `InputManager` и т.д.) будет содержать функции, относящиеся к его специфическому функционалу, что делает код более читаемым и поддерживаемым.

### Интеграция с Алисой ("Домовенок Кузя")

Для интеграции с навыком "Домовенок Кузя" потребуется: 

1.  **Настройка Wi-Fi**: Устройство должно быть подключено к интернету.
2.  **Облачная платформа**: Скорее всего, навык "Домовенок Кузя" работает через какую-либо облачную платформу (например, Яндекс.Облако, MQTT-брокер или HTTP API). Нужно будет изучить документацию навыка для определения метода взаимодействия.
3.  **Отправка команд**: Функция `WiFiManager::sendActionToAlice(const String& action)` будет отвечать за отправку команд на облачную платформу, которая затем будет взаимодействовать с навыком Алисы. Это может быть HTTP POST запрос или публикация сообщения в MQTT-топик.

Например, при получении команды от Алисы (через облако), ESP32 DevKit 38 pin будет вызывать `GateControl::triggerGatePulse()`.

### Сохранение данных

Для сохранения Wi-Fi учетных данных, списка доверенных 433MHz ключей и доверенных GSM номеров будет использоваться встроенная в ESP32 DevKit 38 pin память NVS (Non-Volatile Storage) через библиотеку `Preferences.h`. Это позволит сохранять данные даже после отключения питания.

---



## 4. Рекомендации по докупке компонентов для улучшения продукта

Для повышения функциональности, надежности и удобства использования вашего устройства, а также для реализации полного спектра заявленных возможностей, рекомендуется рассмотреть приобретение дополнительных компонентов. Эти рекомендации разделены на обязательные для полной реализации, компоненты для улучшения надежности и удобства, а также дополнительные возможности для дальнейшего развития проекта.

### Обязательные компоненты для полной реализации

Для полноценной работы устройства, особенно в части управления воротами и интеграции с GSM, необходимы следующие компоненты:

**Релейный модуль (1-канальный, 5В)** является критически важным элементом для управления блоком открытия ворот. В текущей макетной схеме используется светодиод для имитации импульса, однако для реальной коммутации высокого напряжения 220В требуется реле. При выборе релейного модуля важно убедиться, что он рассчитан на требуемое напряжение и ток, потребляемый блоком ворот. Рекомендуется использовать модули с опторазвязкой, чтобы обеспечить электрическую изоляцию и защиту ESP32 от помех и высокого напряжения. Такие модули, как правило, управляются напряжением 5В, что легко реализуется с ESP32, возможно, через дополнительный транзистор для обеспечения достаточного тока управления.

**GSM модуль (например, SIM800L GPRS Module)** необходим для реализации функции управления воротами по звонку или SMS с заранее определенных доверенных номеров. SIM800L является популярным и экономичным решением, легко интегрируемым с ESP32 через интерфейс UART. Однако, следует учитывать, что GSM модули потребляют значительный ток, особенно в пиковых режимах при передаче данных (до 2А). **Крайне не рекомендуется питать его напрямую от 3.3В или 5В пинов ESP32.** Для стабильной работы потребуется внешний источник питания, способный выдавать 3.7-4.2В с достаточным током, или DC-DC преобразователь. Также потребуется активная SIM-карта.

**Стабилизированный блок питания (5В, 2А или более)** обеспечит надежное электропитание всей системы. Встроенный MicroUSB порт ESP32 обычно предоставляет 5В, но его мощности может быть недостаточно для одновременной работы всех компонентов, особенно при добавлении GSM модуля и реле. Рекомендуется использовать адаптер питания 5В с током 2А или 3А, например, от старого смартфона. В случае использования GSM модуля, который требует другого напряжения, потребуется дополнительный DC-DC понижающий преобразователь, такой как LM2596.

### Компоненты для улучшения надежности и удобства

Эти компоненты не являются строго обязательными для базовой функциональности, но значительно улучшат надежность, долговечность и удобство использования готового продукта:

**Корпус для устройства** обеспечит защиту электроники от внешних воздействий, таких как пыль, влага и механические повреждения. Помимо защитной функции, корпус придаст устройству законченный и профессиональный вид. Можно выбрать готовый пластиковый или металлический корпус подходящего размера, либо заказать его 3D-печать по индивидуальному проекту.

**Антенна для 433MHz приемника** поможет значительно улучшить дальность и стабильность приема сигнала с брелков. Хотя простой кусок провода может выполнять функцию антенны, специализированная четвертьволновая спиральная или штыревая антенна, настроенная на частоту 433MHz (длиной около 17.3 см), обеспечит гораздо более эффективный прием сигнала.

**Макетная плата (perfboard) или печатная плата (PCB)** рекомендуется для более надежного и компактного монтажа компонентов после завершения этапа макетирования на breadboard. Соединения на breadboard не всегда стабильны и могут быть подвержены разрывам или помехам при долгосрочной эксплуатации. Переход на perfboard с пайкой или разработка кастомной PCB значительно повысит надежность устройства.

**Набор Dupont-проводов** различных типов (male-female, male-male, female-female) облегчит и упорядочит процесс подключения компонентов на макетной плате. Хотя у вас уже есть провода, наличие разнообразного набора позволит выполнять соединения более аккуратно и эффективно.

### Дополнительные возможности для дальнейшего развития

Для расширения функционала и интеграции с системами умного дома можно рассмотреть следующие датчики:

**Датчик Холла или геркон** может быть использован для получения обратной связи о текущем состоянии ворот (открыты/закрыты). Эта информация может быть отображена в приложении или передана в систему умного дома, например, Алисе, для более полного контроля.

**BME280 (датчик температуры, влажности, давления)** позволит собирать данные об окружающей среде. Эти данные могут быть отображены на дисплее устройства или отправлены в облако для анализа и использования в сценариях умного дома. BME280 подключается по шине I2C, что требует всего двух пинов ESP32.

### Приоритеты при докупке

В первую очередь следует приобрести **релейный модуль** и **стабилизированный блок питания**. Если планируется использование GSM, то **GSM модуль** и соответствующее внешнее питание для него также являются критически важными. Остальные компоненты, хотя и значительно улучшают продукт, могут быть добавлены на последующих этапах разработки.

---


